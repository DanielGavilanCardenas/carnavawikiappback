name: Full Release Cycle & Publish Package

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  check_branch:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Verify source branch
        run: |
          if [ "${{ github.head_ref }}" != "develop" ]; then
            echo "❌ Error: Solo se permiten merges a 'master' desde la rama 'develop'."
            exit 1
          fi

  release-and-publish:
    needs: check_branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MY_RELEASE_PAT }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github # Identificador para el settings.xml

      - name: 1. Prepare Release Version
        id: prep
        run: |
          # Extraer versión actual y quitar -SNAPSHOT
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          RELEASE_VERSION=${VERSION%-SNAPSHOT}
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Actualizar a versión release en master
          mvn versions:set -DnewVersion=$RELEASE_VERSION -DgenerateBackupPoms=false
          git add pom.xml
          git commit -m "chore: release version $RELEASE_VERSION [skip ci]"
          git push origin master

      - name: 2. Build & Publish to GitHub Packages
        # El comando deploy compila, empaqueta y sube el JAR
        run: mvn --batch-mode deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.MY_RELEASE_PAT }}

      - name: 3. Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.prep.outputs.RELEASE_VERSION }}
          name: Release ${{ steps.prep.outputs.RELEASE_VERSION }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.MY_RELEASE_PAT }}

      - name: 4. Bump version on Develop
        run: |
          git checkout develop
          git pull origin develop
          
          # Incrementar versión (ej: 0.1.2 -> 0.1.3-SNAPSHOT)
          mvn build-helper:parse-version versions:set \
            -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion}-SNAPSHOT \
            -DgenerateBackupPoms=false
          
          NEW_DEV_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          git add pom.xml
          git commit -m "chore: bump version to $NEW_DEV_VERSION [skip ci]"
          git push origin develop